# プロジェクト概要:  あしたぼホームページ

## 1. プロジェクトの要約

「あしたぼホームページ」と名付けられたこのプロジェクトは、信州大学および長野県立大学の軽音サークル「あしたぼ」のための多機能なWebアプリケーションです。サークルメンバーが活動を管理し、練習スタジオを予約し、スケジュールを調整し、過去の演奏動画を閲覧するための中心的なハブとして機能します。

このプラットフォームは、メンバー管理、イベントスケジューリング、コンテンツ共有（YouTube動画）、そしてユーザーエンゲージメントを高めるためのゲーミフィケーション要素（「ガチャ」システム）を統合しています。また、アプリケーションのデータとユーザーを管理するための堅牢な管理システムも備えています。

## 2. 技術アーキテクチャ

### 2.1. 主要技術スタック

- **フレームワーク:** Next.js (v15.3.2) (App Routerを使用)
- **言語:** TypeScript
- **データベース:** PostgreSQL
- **ORM:** Prisma
- **UIフレームワーク:** Tailwind CSS と daisyUI コンポーネント
- **認証:** NextAuth.js (LINE認証に特化)
- **状態管理・データフェッチ:** SWR および React Hooks
- **フォーム処理:** React Hook Form と Yup (バリデーション用)
- **アニメーション:** GSAP (GreenSock Animation Platform)

### 2.2. 主要な統合とサービス

- **アナリティクス:** Vercel Analytics, Speed Insights, Google Analytics
- **ファイルストレージ:** AWS S3互換のCloudflare R2 (署名付きURLによる画像配信)
- **メッセージングプラットフォーム連携:** LINE Front-end Framework (LIFF)
- **コンテンツレンダリング:** MDX (ブログや規約ページ用)
- **画像最適化・配信:** Cloudflare Workers (カスタム画像フィルタリング/最適化)
- **YouTube連携:** Google APIs (YouTube Data API v3)

## 3. 主要機能と機能詳細

### 3.1. ユーザー向け機能

- **ホームページ (`/`):** サークル紹介、カルーセル、主要機能へのナビゲーションボタンを提供します。
- **予約システム (`/booking`):** アプリケーションの核となる機能です。
  - **コマ表予約:** メンバーは練習室やスタジオの利用枠を予約できます。
  - **予約禁止日:** 管理者によって設定された予約不可の日時が表示されます。
  - **予約のバリデーション:** 重複予約、過去の日付、予約可能日数超過、予約禁止時間帯の厳密なチェックが行われます。
  - **パスワード認証:** 予約にはパスワードを設定でき、認証失敗回数によるロックアウト機能も備わっています。
- **ユーザープロフィール (`/user`):**
  - メンバーは本名、学籍番号、卒業予定年度、役割（現役生/卒業生）、担当楽器（複数選択可）を含む詳細なプロフィールを登録・編集できます。
  - 自身の予約履歴やガチャログを閲覧できます。
- **動画アーカイブ (`/video`):**
  - サークルの公式YouTubeチャンネルのプレイリストと動画を閲覧できます。
  - ライブ/バンドカテゴリ、バンド名、ライブ名、タグ（AND/OR検索）、ソート（新しい順/古い順）、ページネーションによる高度な検索・フィルタリングが可能です。
  - 動画やプレイリストにタグを付与・更新できます。
- **ガチャ（ゲーミフィケーション）システム:**
  - ユーザーはガチャをプレイし、様々なレアリティ（COMMON, RARE, SUPER_RARE, SS_RARE, ULTRA_RARE, SECRET_RARE）のデジタルアイテム（画像）を取得できます。
  - 1日あたりのプレイ回数制限が設けられています。
  - 取得したガチャ結果はユーザーのプロフィールページで確認できます。
- **日程調整機能 (`/schedule`):**
  - バンド練習やライブ、その他サークル内のイベントの日程調整を作成・管理できます。
  - 特定のメンバーをメンション（参加者として指定）する機能があります。
  - 通常の予約時間帯（コマ表）を超えた「細かい時間指定」も可能です。

### 3.2. 管理者向け機能 (`/admin`)

- **ユーザー管理:**
  - 全ユーザーの一覧表示、ユーザーの削除、アカウントロール（USER, ADMIN, TOPADMIN）の変更が可能です。
  - 管理者権限のチェックが厳密に行われます。
- **PadLock管理:**
  - 特定の管理ページや機能へのアクセスをパスワードで保護するPadLockの作成・削除が可能です。
- **予約禁止日管理:**
  - 予約システムにおいて、特定の期間や時間帯を予約不可として設定・削除できます。
- **YouTube管理:**
  - YouTube API連携を通じて、プレイリストと動画情報をデータベースに同期・更新できます。

## 4. データモデル概要 (`prisma/schema.prisma`)

データベーススキーマは、以下の主要なエンティティを中心に構成されています。

- **`User` & `Profile`:** ユーザーの基本情報と、サークル活動に特化した詳細なプロフィール情報（学籍番号、役割、担当楽器など）を管理します。
- **`Booking`, `ExBooking`, `BuyBooking`:** 練習室予約のライフサイクル全体（予約枠、予約禁止日、予約の購入/支払い状況）を管理します。
- **`Schedule`, `Timeslot`, `UserSchedule`, `UserTimeslot`:** メンバー間の日程調整機能のデータ構造を定義し、柔軟な時間スロット管理を可能にします。
- **`Playlist` & `Video`:** YouTubeのプレイリストと動画の情報を管理します。
- **`UserGacha`:** ユーザーがガチャで取得したアイテムの履歴を記録します。
- **`PadLock` & `PadlockAttempt`:** パスワード保護機能と、不正なアクセス試行の記録を管理します。
- **`YoutubeAuth`:** YouTube API認証トークンを安全に保存します。

## 5. アプリケーション構造

プロジェクトは、Next.jsのApp Routerと機能駆動型（Feature-driven）の構造を採用しています。これにより、各機能が独立したモジュールとして開発・管理され、コードの凝集度が高く、保守性・拡張性に優れています。

- **`src/app`:**
  - Next.jsのApp Routerのルートディレクトリであり、ページルーティング、グローバルレイアウト (`layout.tsx`)、エラーページ (`global-error.tsx`, `not-found.tsx`)、ミドルウェア (`middleware.ts`)、グローバルCSS (`globals.css`) など、アプリケーションの基盤となる部分を構成します。
  - サーバーアクション (`actions.ts`) や、Sentryなどの計測ツールの初期化 (`instrumentation.ts`, `instrumentation-client.ts`) もここに含まれます。
- **`src/components`:**
  - アプリケーション全体で再利用される汎用的なUIコンポーネントを格納します。
  - `src/components/ui/atoms`: ボタン、入力フィールド、ローディング表示など、最小単位のUI要素。
  - `src/components/ui/molecules`: `atoms` を組み合わせて作られた、より複雑なUI要素（例: ポップアップ、テーブルボックス）。
  - `src/components/home`: ホームページ固有のコンポーネント（例: `HomeCarousel`, `HomeButton`）。
- **`src/lib`:**
  - アプリケーション全体で利用される共通のライブラリやユーティリティ関数を配置します。
  - `src/lib/prisma`: Prismaクライアントの初期化とシングルトン管理、シードスクリプト。
  - `src/lib/liff`: LINE Front-end Framework (LIFF) の連携設定。
  - `src/lib/image`: Cloudflare R2 (S3互換ストレージ) からの署名付きURL生成など、画像処理関連のユーティリティ。
  - `src/lib/fonts`: カスタムフォントファイル。
- **`src/features`:**

  - アプリケーションの主要なビジネスロジックと、それに関連するUIコンポーネント、データアクセス層、型定義が機能ごとにカプセル化されています。各機能ディレクトリは、以下のサブディレクトリを持つことが一般的です。

    - `types.ts`: その機能で使用されるTypeScriptの型定義。
    - `lib/repository.ts`: Prismaクライアントを介したデータベース操作（CRUD）を抽象化するリポジトリ層。
    - `components/`: その機能に特化したReactコンポーネント。
    - `actions.ts`: Next.jsのサーバーアクションとして定義された、サーバーサイドのビジネスロジック。
    - `context/`: React Context API を使用した状態管理（例: `GachaDataContext`）。
    - `hooks/`: カスタムReactフック。
    - `config/`: 機能固有の設定値。

  - **`src/features/admin` (管理者機能):**
    - **役割:** ユーザー管理、PadLock管理、予約禁止日管理、YouTubeデータ同期など、管理者向けの操作を提供します。
    - **主要ファイル:**
      - `actions.ts`: ユーザーの役割変更、削除、PadLockの作成/削除、予約禁止日の設定/削除など、管理者権限を必要とするサーバーアクション。
      - `lib/repository.ts`: 管理者機能が利用するデータベース操作。
      - `types.ts`: PadLockなどの管理者固有の型定義。
      - `components/`: 管理者パネルのUIコンポーネント（例: `AdminUserPage`, `ForbiddenBookingCreate`）。
  - **`src/features/auth` (認証機能):**
    - **役割:** NextAuth.jsとLINE認証を基盤としたユーザー認証、セッション管理、アクセス制御を担います。
    - **主要ファイル:**
      - `lib/authOption.ts`: NextAuth.jsのメイン設定ファイル。JWTセッション戦略、Prismaアダプター、カスタムコールバックによるセッション拡張（プロフィール情報など）を定義。
      - `lib/auth.config.ts`: LINE認証プロバイダーの設定。
      - `lib/unifiedAuth.ts`: クライアントサイドとミドルウェアで利用される認証状態判定ヘルパー関数。
      - `lib/repository.ts`: 認証関連のデータベース操作（ユーザー取得など）。
      - `types.ts`: 認証関連の型定義。
      - `components/`: サインイン、サインアウト、セッション期限切れなどのUIコンポーネント。
  - **`src/features/booking` (予約機能):**
    - **役割:** 練習室やスタジオの予約、予約禁止日の管理、予約のパスワード認証など、予約システムの中心的な機能を提供します。
    - **主要ファイル:**
      - `actions.ts`: 予約の作成、更新、削除、パスワード認証、予約禁止日の取得など、予約に関するサーバーアクション。
      - `lib/repository.ts`: 予約関連のデータベース操作。
      - `types.ts`: 予約、予約禁止、予約購入、時間帯などの型定義。
      - `components/`: 予約カレンダー (`BookingCalendar`), 予約メインページ (`MainPage`), 予約作成/編集フォームなど。
      - `config.ts`: 予約可能日数などの設定値。
  - **`src/features/gacha` (ガチャ機能):**
    - **役割:** ユーザーがデジタルアイテムを取得できるガチャシステムを実装します。
    - **主要ファイル:**
      - `components/actions.ts`: ガチャ結果の保存、ガチャログの取得、署名付きURLの生成など、ガチャに関するサーバーアクション。
      - `lib/repository.ts`: ガチャ関連のデータベース操作。
      - `types.ts`: ガチャアイテムのレアリティ、データ構造などの型定義。
      - `components/`: ガチャのメインポップアップ (`GachaMainPopup`), ガチャ結果表示 (`GachaResult`), アニメーション (`animations/CardAnimation`), 画像カルーセル (`ImageCarousel`) など。
      - `context/GachaDataContext.tsx`: ガチャデータを提供するReact Context。
      - `config/gachaConfig.ts`: ガチャのプレイ回数制限などの設定値。
  - **`src/features/schedule` (日程調整機能):**
    - **役割:** メンバーがバンド練習やイベントの日程を調整し、共有するための機能を提供します。
    - **主要ファイル:**
      - `actions/actions.ts`: スケジュール作成、更新、削除、参加などのサーバーアクション。
      - `lib/repository.ts`: スケジュール関連のデータベース操作。
      - `types.ts`: スケジュール、タイムスロット、参加者などの型定義、および時間スロット生成ロジック。
      - `components/`: スケジュール作成ページ (`CreatePage`), スケジュール一覧ページなど。
  - **`src/features/user` (ユーザー機能):**
    - **役割:** ユーザープロフィールの管理、予約ログ、ガチャログの表示など、ユーザー固有の機能を提供します。
    - **主要ファイル:**
      - `actions.ts`: サインアウトなどのユーザー関連サーバーアクション。
      - `lib/repository.ts`: ユーザープロフィール関連のデータベース操作。
      - `types.ts`: ユーザー、プロフィール、役割、楽器パートなどの型定義。
      - `components/`: プロフィール表示 (`ProfileDisplay`), プロフィール編集 (`ProfileEdit`), 予約ログ表示 (`BookingLogs`), ガチャログ表示 (`GachaLogs`) など。
  - **`src/features/video` (動画機能):**
    - **役割:** YouTube動画の閲覧、検索、タグ管理、YouTube API連携を担います。
    - **主要ファイル:**
      - `components/actions.ts`: YouTube APIからのデータ取得、データベースへの保存、動画検索、タグ更新など、動画に関するサーバーアクション。
      - `lib/repository.ts`: 動画関連のデータベース操作。
      - `types.ts`: 動画、プレイリスト、YouTube認証トークン、検索クエリなどの型定義。
      - `components/`: 動画一覧ページ (`VideoListPage`), 動画アイテム (`VideoItem`), 動画検索フォーム (`VideoSearchForm`) など。

- **`prisma`:**
  - データベーススキーマ定義 (`schema.prisma`) を格納し、アプリケーションのデータ構造の基盤となります。
  - `seed.ts`, `bookingseed.ts` などのシードスクリプトも含まれ、開発・テスト用の初期データを提供します。
- **`public`:**
  - 静的アセット（画像、フォント、ファビコンなど）を格納します。Next.jsによって直接配信されます。
- **`document`:**
  - 開発者向けの各種ドキュメントを格納します。
    - `coding.md`: Gitのワークフローとコーディング規約。
    - `design.md`: デザイン開発のための環境構築ガイド。
    - `docker.md`: Dockerを使った開発環境構築ガイド。
    - `react.md`: Reactの基本的な概念。
    - `task_docker.md`: Docker関連のタスク説明。

## 6. 開発環境と運用

- **開発環境:** Docker と WSL2 を利用したコンテナベースの開発環境が推奨されており、`Makefile` を通じて `docker-compose` コマンドを簡単に実行できます（例: `make new`, `make up`, `make renew`）。
- **コード品質:** ESLint (`next/core-web-vitals`) と Prettier (`.prettierrc.yaml`で詳細なルール定義) により、コードの品質と一貫性が保たれています。
- **監視と分析:** Vercel Analytics, Speed Insights, Google Analyticsによるパフォーマンスと利用状況の分析が導入されています。
- **キャッシュ戦略:** Next.jsの `revalidateTag` や `unstable_cache` を積極的に利用し、サーバーサイドレンダリングとデータフェッチのパフォーマンスを最適化しています。

## 7. プロジェクトの目的

このプロジェクトの主な目的は、軽音サークル「あしたぼ」のメンバーが、練習室の予約、日程調整、過去のライブ映像の閲覧、そしてエンターテイメントとしてのガチャ機能を通じて、より効率的かつ楽しく活動できるようにすることです。特に、学生というターゲット層に合わせた学籍番号によるプロフィール管理や、LINE連携、ユーモラスなドキュメントなど、ユーザーフレンドリーな設計が随所に見られます。
